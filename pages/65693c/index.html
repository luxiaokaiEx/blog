<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>eureka | 卢晓凯博客</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/blog/img/favicon.ico">
    <meta name="description" content="让梦想在指尖上飞舞，让精彩在低调中绽放">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/blog/assets/css/0.styles.7758e167.css" as="style"><link rel="preload" href="/blog/assets/js/app.b5a3e498.js" as="script"><link rel="preload" href="/blog/assets/js/2.54247e65.js" as="script"><link rel="preload" href="/blog/assets/js/84.a457ec68.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.90642ad6.js"><link rel="prefetch" href="/blog/assets/js/100.a4c7bfbc.js"><link rel="prefetch" href="/blog/assets/js/101.33572c4e.js"><link rel="prefetch" href="/blog/assets/js/102.c0f02151.js"><link rel="prefetch" href="/blog/assets/js/103.6c9fb4d0.js"><link rel="prefetch" href="/blog/assets/js/104.2a03f19e.js"><link rel="prefetch" href="/blog/assets/js/105.d9575ac8.js"><link rel="prefetch" href="/blog/assets/js/106.6a467f4a.js"><link rel="prefetch" href="/blog/assets/js/107.9c192821.js"><link rel="prefetch" href="/blog/assets/js/108.c6209e7d.js"><link rel="prefetch" href="/blog/assets/js/109.3c8e69e1.js"><link rel="prefetch" href="/blog/assets/js/11.7f455c7a.js"><link rel="prefetch" href="/blog/assets/js/110.8f794c20.js"><link rel="prefetch" href="/blog/assets/js/111.c116edcd.js"><link rel="prefetch" href="/blog/assets/js/112.ada22db5.js"><link rel="prefetch" href="/blog/assets/js/113.0ba4a4c2.js"><link rel="prefetch" href="/blog/assets/js/114.b4cff4d1.js"><link rel="prefetch" href="/blog/assets/js/115.cc34750c.js"><link rel="prefetch" href="/blog/assets/js/116.4e4722c2.js"><link rel="prefetch" href="/blog/assets/js/117.5f457999.js"><link rel="prefetch" href="/blog/assets/js/118.946ac8de.js"><link rel="prefetch" href="/blog/assets/js/119.f3cb5b72.js"><link rel="prefetch" href="/blog/assets/js/12.0175221e.js"><link rel="prefetch" href="/blog/assets/js/120.15692e7a.js"><link rel="prefetch" href="/blog/assets/js/121.434b6841.js"><link rel="prefetch" href="/blog/assets/js/122.0ae161c6.js"><link rel="prefetch" href="/blog/assets/js/123.66a87129.js"><link rel="prefetch" href="/blog/assets/js/124.137806b0.js"><link rel="prefetch" href="/blog/assets/js/125.9ea42297.js"><link rel="prefetch" href="/blog/assets/js/126.61e2cf2f.js"><link rel="prefetch" href="/blog/assets/js/127.6b352d76.js"><link rel="prefetch" href="/blog/assets/js/128.16366692.js"><link rel="prefetch" href="/blog/assets/js/129.3b3a7a35.js"><link rel="prefetch" href="/blog/assets/js/13.44bc1050.js"><link rel="prefetch" href="/blog/assets/js/130.37cbad2f.js"><link rel="prefetch" href="/blog/assets/js/131.a336760d.js"><link rel="prefetch" href="/blog/assets/js/132.fbef77e9.js"><link rel="prefetch" href="/blog/assets/js/133.83b0592a.js"><link rel="prefetch" href="/blog/assets/js/134.6546bf0b.js"><link rel="prefetch" href="/blog/assets/js/135.66788a21.js"><link rel="prefetch" href="/blog/assets/js/136.eec97c0b.js"><link rel="prefetch" href="/blog/assets/js/137.ab189a6a.js"><link rel="prefetch" href="/blog/assets/js/138.d317a19a.js"><link rel="prefetch" href="/blog/assets/js/139.76682d29.js"><link rel="prefetch" href="/blog/assets/js/14.0a7de9c9.js"><link rel="prefetch" href="/blog/assets/js/140.3270dcfc.js"><link rel="prefetch" href="/blog/assets/js/141.dacee2bb.js"><link rel="prefetch" href="/blog/assets/js/142.9c9104b3.js"><link rel="prefetch" href="/blog/assets/js/143.2a1493f0.js"><link rel="prefetch" href="/blog/assets/js/144.c847289f.js"><link rel="prefetch" href="/blog/assets/js/145.4f68d102.js"><link rel="prefetch" href="/blog/assets/js/146.aaa2a6b4.js"><link rel="prefetch" href="/blog/assets/js/147.04bcaaef.js"><link rel="prefetch" href="/blog/assets/js/148.dc72e45a.js"><link rel="prefetch" href="/blog/assets/js/149.47d1f466.js"><link rel="prefetch" href="/blog/assets/js/15.9ff31133.js"><link rel="prefetch" href="/blog/assets/js/150.818175f9.js"><link rel="prefetch" href="/blog/assets/js/151.ed36940c.js"><link rel="prefetch" href="/blog/assets/js/152.34f9c271.js"><link rel="prefetch" href="/blog/assets/js/153.05c6e599.js"><link rel="prefetch" href="/blog/assets/js/154.9a576635.js"><link rel="prefetch" href="/blog/assets/js/155.ccf85f09.js"><link rel="prefetch" href="/blog/assets/js/156.c40c89e1.js"><link rel="prefetch" href="/blog/assets/js/157.ef69e50d.js"><link rel="prefetch" href="/blog/assets/js/158.df24f1df.js"><link rel="prefetch" href="/blog/assets/js/159.8f75e4b8.js"><link rel="prefetch" href="/blog/assets/js/16.447bf2f6.js"><link rel="prefetch" href="/blog/assets/js/160.7652a41d.js"><link rel="prefetch" href="/blog/assets/js/161.9719a9f6.js"><link rel="prefetch" href="/blog/assets/js/162.21255d53.js"><link rel="prefetch" href="/blog/assets/js/163.e3771d0d.js"><link rel="prefetch" href="/blog/assets/js/164.242dc550.js"><link rel="prefetch" href="/blog/assets/js/165.99ac64bf.js"><link rel="prefetch" href="/blog/assets/js/166.5c7aedb0.js"><link rel="prefetch" href="/blog/assets/js/167.fafdbe81.js"><link rel="prefetch" href="/blog/assets/js/168.6b82118f.js"><link rel="prefetch" href="/blog/assets/js/169.2eb2339b.js"><link rel="prefetch" href="/blog/assets/js/17.ed1d707d.js"><link rel="prefetch" href="/blog/assets/js/170.05ababed.js"><link rel="prefetch" href="/blog/assets/js/171.ddb298d0.js"><link rel="prefetch" href="/blog/assets/js/172.3ba7ee86.js"><link rel="prefetch" href="/blog/assets/js/173.a119f0a7.js"><link rel="prefetch" href="/blog/assets/js/174.0f108c2b.js"><link rel="prefetch" href="/blog/assets/js/175.192556e2.js"><link rel="prefetch" href="/blog/assets/js/176.fb5dcb8c.js"><link rel="prefetch" href="/blog/assets/js/177.68631e88.js"><link rel="prefetch" href="/blog/assets/js/178.c7bcd2d8.js"><link rel="prefetch" href="/blog/assets/js/179.1bb7c0d4.js"><link rel="prefetch" href="/blog/assets/js/18.8b023b80.js"><link rel="prefetch" href="/blog/assets/js/180.fcb03dc0.js"><link rel="prefetch" href="/blog/assets/js/181.0b2f3ae3.js"><link rel="prefetch" href="/blog/assets/js/182.55e15eb2.js"><link rel="prefetch" href="/blog/assets/js/183.f9e39f1f.js"><link rel="prefetch" href="/blog/assets/js/184.17ff8e00.js"><link rel="prefetch" href="/blog/assets/js/185.1f1abe34.js"><link rel="prefetch" href="/blog/assets/js/186.9855d491.js"><link rel="prefetch" href="/blog/assets/js/187.4eb56f9c.js"><link rel="prefetch" href="/blog/assets/js/188.4144a52d.js"><link rel="prefetch" href="/blog/assets/js/189.8c87e688.js"><link rel="prefetch" href="/blog/assets/js/19.ba0eb3e4.js"><link rel="prefetch" href="/blog/assets/js/190.c8ccd784.js"><link rel="prefetch" href="/blog/assets/js/191.d498e36c.js"><link rel="prefetch" href="/blog/assets/js/192.3fd6c202.js"><link rel="prefetch" href="/blog/assets/js/193.abb22464.js"><link rel="prefetch" href="/blog/assets/js/194.7c657be3.js"><link rel="prefetch" href="/blog/assets/js/195.def3cd71.js"><link rel="prefetch" href="/blog/assets/js/196.fa18a652.js"><link rel="prefetch" href="/blog/assets/js/197.7a0025e3.js"><link rel="prefetch" href="/blog/assets/js/198.d7c62a7e.js"><link rel="prefetch" href="/blog/assets/js/199.5b1f084b.js"><link rel="prefetch" href="/blog/assets/js/20.99378379.js"><link rel="prefetch" href="/blog/assets/js/200.6e50c338.js"><link rel="prefetch" href="/blog/assets/js/201.117b6b83.js"><link rel="prefetch" href="/blog/assets/js/202.57e49225.js"><link rel="prefetch" href="/blog/assets/js/203.e040335d.js"><link rel="prefetch" href="/blog/assets/js/204.0c7e36e8.js"><link rel="prefetch" href="/blog/assets/js/205.24f4e805.js"><link rel="prefetch" href="/blog/assets/js/206.821480a2.js"><link rel="prefetch" href="/blog/assets/js/207.d6227be6.js"><link rel="prefetch" href="/blog/assets/js/208.b7ac4d01.js"><link rel="prefetch" href="/blog/assets/js/209.2730e470.js"><link rel="prefetch" href="/blog/assets/js/21.3ed664d2.js"><link rel="prefetch" href="/blog/assets/js/210.5d11c882.js"><link rel="prefetch" href="/blog/assets/js/211.ed0e2466.js"><link rel="prefetch" href="/blog/assets/js/212.904f0bed.js"><link rel="prefetch" href="/blog/assets/js/213.f770997a.js"><link rel="prefetch" href="/blog/assets/js/214.9262ad66.js"><link rel="prefetch" href="/blog/assets/js/215.270b4d0c.js"><link rel="prefetch" href="/blog/assets/js/216.3eb3e151.js"><link rel="prefetch" href="/blog/assets/js/217.8d9dffe3.js"><link rel="prefetch" href="/blog/assets/js/218.89e0b39b.js"><link rel="prefetch" href="/blog/assets/js/219.9aa621cb.js"><link rel="prefetch" href="/blog/assets/js/22.ffdc82f3.js"><link rel="prefetch" href="/blog/assets/js/220.81f7f3fe.js"><link rel="prefetch" href="/blog/assets/js/221.53d35a7b.js"><link rel="prefetch" href="/blog/assets/js/222.ed3c1f57.js"><link rel="prefetch" href="/blog/assets/js/223.01cf6ba2.js"><link rel="prefetch" href="/blog/assets/js/224.a32b9911.js"><link rel="prefetch" href="/blog/assets/js/225.2b692504.js"><link rel="prefetch" href="/blog/assets/js/226.05528809.js"><link rel="prefetch" href="/blog/assets/js/227.78c67da4.js"><link rel="prefetch" href="/blog/assets/js/228.fa3f7d59.js"><link rel="prefetch" href="/blog/assets/js/229.11d0c52c.js"><link rel="prefetch" href="/blog/assets/js/23.7aaad5b5.js"><link rel="prefetch" href="/blog/assets/js/230.99b3c95d.js"><link rel="prefetch" href="/blog/assets/js/231.4bb6c12b.js"><link rel="prefetch" href="/blog/assets/js/232.a4ceea35.js"><link rel="prefetch" href="/blog/assets/js/233.14382374.js"><link rel="prefetch" href="/blog/assets/js/234.848a0551.js"><link rel="prefetch" href="/blog/assets/js/235.8ef5b0cd.js"><link rel="prefetch" href="/blog/assets/js/236.3d16aa5b.js"><link rel="prefetch" href="/blog/assets/js/237.f3b8152d.js"><link rel="prefetch" href="/blog/assets/js/238.fba0cedf.js"><link rel="prefetch" href="/blog/assets/js/239.fbe3523d.js"><link rel="prefetch" href="/blog/assets/js/24.d7dca157.js"><link rel="prefetch" href="/blog/assets/js/240.4fb4d431.js"><link rel="prefetch" href="/blog/assets/js/241.8a58e661.js"><link rel="prefetch" href="/blog/assets/js/242.820d8bbc.js"><link rel="prefetch" href="/blog/assets/js/243.35442a40.js"><link rel="prefetch" href="/blog/assets/js/244.9d8d5d85.js"><link rel="prefetch" href="/blog/assets/js/245.f1f96c18.js"><link rel="prefetch" href="/blog/assets/js/246.cb5b5543.js"><link rel="prefetch" href="/blog/assets/js/25.eeaff119.js"><link rel="prefetch" href="/blog/assets/js/26.efa9df2a.js"><link rel="prefetch" href="/blog/assets/js/27.41e4dba0.js"><link rel="prefetch" href="/blog/assets/js/28.7f2fee4f.js"><link rel="prefetch" href="/blog/assets/js/29.c31e0387.js"><link rel="prefetch" href="/blog/assets/js/3.92994e45.js"><link rel="prefetch" href="/blog/assets/js/30.dd4a2764.js"><link rel="prefetch" href="/blog/assets/js/31.a2459775.js"><link rel="prefetch" href="/blog/assets/js/32.6f278954.js"><link rel="prefetch" href="/blog/assets/js/33.f2a21ab3.js"><link rel="prefetch" href="/blog/assets/js/34.01915535.js"><link rel="prefetch" href="/blog/assets/js/35.2ac00d83.js"><link rel="prefetch" href="/blog/assets/js/36.5563ea70.js"><link rel="prefetch" href="/blog/assets/js/37.189d2015.js"><link rel="prefetch" href="/blog/assets/js/38.fbb768e0.js"><link rel="prefetch" href="/blog/assets/js/39.02947186.js"><link rel="prefetch" href="/blog/assets/js/4.1a915179.js"><link rel="prefetch" href="/blog/assets/js/40.9c928c87.js"><link rel="prefetch" href="/blog/assets/js/41.321b7160.js"><link rel="prefetch" href="/blog/assets/js/42.0841f991.js"><link rel="prefetch" href="/blog/assets/js/43.f9a6c44a.js"><link rel="prefetch" href="/blog/assets/js/44.86fa98ce.js"><link rel="prefetch" href="/blog/assets/js/45.fcffc65b.js"><link rel="prefetch" href="/blog/assets/js/46.8adc9063.js"><link rel="prefetch" href="/blog/assets/js/47.040cf904.js"><link rel="prefetch" href="/blog/assets/js/48.ed19895a.js"><link rel="prefetch" href="/blog/assets/js/49.5eb3e803.js"><link rel="prefetch" href="/blog/assets/js/5.835b5e7b.js"><link rel="prefetch" href="/blog/assets/js/50.5512527c.js"><link rel="prefetch" href="/blog/assets/js/51.7cf5187f.js"><link rel="prefetch" href="/blog/assets/js/52.6181b6da.js"><link rel="prefetch" href="/blog/assets/js/53.c9bd554e.js"><link rel="prefetch" href="/blog/assets/js/54.3af47ae6.js"><link rel="prefetch" href="/blog/assets/js/55.3fd4a8c5.js"><link rel="prefetch" href="/blog/assets/js/56.98fb2046.js"><link rel="prefetch" href="/blog/assets/js/57.fc16c4d1.js"><link rel="prefetch" href="/blog/assets/js/58.e17637ba.js"><link rel="prefetch" href="/blog/assets/js/59.d877df3c.js"><link rel="prefetch" href="/blog/assets/js/6.9147e28e.js"><link rel="prefetch" href="/blog/assets/js/60.0a6a7999.js"><link rel="prefetch" href="/blog/assets/js/61.4ae6380e.js"><link rel="prefetch" href="/blog/assets/js/62.37195586.js"><link rel="prefetch" href="/blog/assets/js/63.e78a861d.js"><link rel="prefetch" href="/blog/assets/js/64.cbae3378.js"><link rel="prefetch" href="/blog/assets/js/65.bab024bc.js"><link rel="prefetch" href="/blog/assets/js/66.3190c8aa.js"><link rel="prefetch" href="/blog/assets/js/67.945446b5.js"><link rel="prefetch" href="/blog/assets/js/68.9cf53668.js"><link rel="prefetch" href="/blog/assets/js/69.5b3664cd.js"><link rel="prefetch" href="/blog/assets/js/7.6537dd6b.js"><link rel="prefetch" href="/blog/assets/js/70.e9ffd19c.js"><link rel="prefetch" href="/blog/assets/js/71.28d8da0c.js"><link rel="prefetch" href="/blog/assets/js/72.2d5a623a.js"><link rel="prefetch" href="/blog/assets/js/73.7805f557.js"><link rel="prefetch" href="/blog/assets/js/74.6497ec84.js"><link rel="prefetch" href="/blog/assets/js/75.4fb067f9.js"><link rel="prefetch" href="/blog/assets/js/76.6ccd5a29.js"><link rel="prefetch" href="/blog/assets/js/77.eeaea387.js"><link rel="prefetch" href="/blog/assets/js/78.769b0e19.js"><link rel="prefetch" href="/blog/assets/js/79.605d03c9.js"><link rel="prefetch" href="/blog/assets/js/8.3d3f7b89.js"><link rel="prefetch" href="/blog/assets/js/80.1cd3c30f.js"><link rel="prefetch" href="/blog/assets/js/81.50138719.js"><link rel="prefetch" href="/blog/assets/js/82.8aea023f.js"><link rel="prefetch" href="/blog/assets/js/83.14cb03b4.js"><link rel="prefetch" href="/blog/assets/js/85.7829e892.js"><link rel="prefetch" href="/blog/assets/js/86.eca3d6be.js"><link rel="prefetch" href="/blog/assets/js/87.49e0348d.js"><link rel="prefetch" href="/blog/assets/js/88.c492a970.js"><link rel="prefetch" href="/blog/assets/js/89.989712ce.js"><link rel="prefetch" href="/blog/assets/js/9.75f10d87.js"><link rel="prefetch" href="/blog/assets/js/90.94442bae.js"><link rel="prefetch" href="/blog/assets/js/91.e6541063.js"><link rel="prefetch" href="/blog/assets/js/92.c4fead94.js"><link rel="prefetch" href="/blog/assets/js/93.23d48dd2.js"><link rel="prefetch" href="/blog/assets/js/94.e38fcb6b.js"><link rel="prefetch" href="/blog/assets/js/95.2045be00.js"><link rel="prefetch" href="/blog/assets/js/96.58968759.js"><link rel="prefetch" href="/blog/assets/js/97.82ecea38.js"><link rel="prefetch" href="/blog/assets/js/98.6fc6b44c.js"><link rel="prefetch" href="/blog/assets/js/99.2e09b81e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.7758e167.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/logo.png" alt="卢晓凯博客" class="logo"> <span class="site-name can-hide">卢晓凯博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/blog/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/blog/note/js/" class="nav-link">《JavaScript高级程序设计》</a></li><li class="dropdown-subitem"><a href="/blog/note/es6/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-subitem"><a href="/blog/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-subitem"><a href="/blog/note/react/" class="nav-link">《React》</a></li><li class="dropdown-subitem"><a href="/blog/note/typescript-axios/" class="nav-link">《TypeScript 从零实现 axios》</a></li><li class="dropdown-subitem"><a href="/blog/note/git/" class="nav-link">《Git》</a></li><li class="dropdown-subitem"><a href="/blog/pages/51afd6/" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/blog/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/blog/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/blog/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/blog/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/blog/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/blog/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/blog/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/blog/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/luxiaokaiEx/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fup.enterdesk.com%2Fedpic_source%2F9e%2F32%2F9a%2F9e329acc0c79523b0204f6ed7ea1e45e.jpg&amp;refer=http%3A%2F%2Fup.enterdesk.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1655723117&amp;t=c8a4823fe2c402ca288fbe5dbd7e4868"> <div class="blogger-info"><h3>XiaoKai Lu</h3> <span>java开发</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/blog/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/blog/note/js/" class="nav-link">《JavaScript高级程序设计》</a></li><li class="dropdown-subitem"><a href="/blog/note/es6/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-subitem"><a href="/blog/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-subitem"><a href="/blog/note/react/" class="nav-link">《React》</a></li><li class="dropdown-subitem"><a href="/blog/note/typescript-axios/" class="nav-link">《TypeScript 从零实现 axios》</a></li><li class="dropdown-subitem"><a href="/blog/note/git/" class="nav-link">《Git》</a></li><li class="dropdown-subitem"><a href="/blog/pages/51afd6/" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/blog/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/blog/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/blog/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/blog/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/blog/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/blog/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/blog/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/blog/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/blog/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/luxiaokaiEx/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>eureka</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/pages/65693c/#eureka集群" class="sidebar-link">eureka集群:</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/blog/pages/65693c/#eureka集群原理" class="sidebar-link">eureka集群原理</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/65693c/#eureka集群配置" class="sidebar-link">eureka集群配置</a></li></ul></li><li><a href="/blog/pages/65693c/#cap定理的含义" class="sidebar-link">CAP定理的含义：</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/blog/pages/65693c/#partition-tolerance" class="sidebar-link">Partition tolerance</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/65693c/#consistency" class="sidebar-link">Consistency</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/65693c/#availability" class="sidebar-link">Availability</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/65693c/#consistency-和-availability-的矛盾" class="sidebar-link">Consistency 和 Availability 的矛盾</a></li></ul></li><li><a href="/blog/pages/65693c/#eureka对比zookeeper" class="sidebar-link">Eureka对比Zookeeper：</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/pages/65693c/#源码解析" class="sidebar-link">源码解析：</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/blog/pages/65693c/#eureka-server源码" class="sidebar-link">Eureka Server源码</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#配置生效" class="sidebar-link">配置生效</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#服务注册" class="sidebar-link">服务注册</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#心跳续约" class="sidebar-link">心跳续约</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#服务下架" class="sidebar-link">服务下架</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#服务剔除" class="sidebar-link">服务剔除</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#集群同步" class="sidebar-link">集群同步</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#自我保护机制" class="sidebar-link">自我保护机制</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/65693c/#eureka-client-源码" class="sidebar-link">Eureka Client 源码</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#配置生效-2" class="sidebar-link">配置生效</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#服务注册-2" class="sidebar-link">服务注册</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#心跳续约-2" class="sidebar-link">心跳续约</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#服务下架-2" class="sidebar-link">服务下架</a></li><li class="sidebar-sub-header level4"><a href="/blog/pages/65693c/#服务发现" class="sidebar-link">服务发现</a></li><li class="sidebar-sub-header level5"><a href="/blog/pages/65693c/#增量拉取" class="sidebar-link">增量拉取</a></li><li class="sidebar-sub-header level5"><a href="/blog/pages/65693c/#全量拉取" class="sidebar-link">全量拉取</a></li></ul></li><li><a href="/blog/pages/65693c/#对于eureka的保留问题" class="sidebar-link">对于eureka的保留问题</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><!----> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/luxiaokai" target="_blank" title="作者" class="beLink" data-v-1baff76c>luxiaokai</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-05-20</a></div> <div title="分类" class="date iconfont icon-wenjian" data-v-1baff76c><a href="/blog/categories/?category=%E6%8A%80%E6%9C%AF" data-v-1baff76c>技术 </a><a href="/blog/categories/?category=%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3" data-v-1baff76c>技术文档 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">eureka<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="eureka"><a href="#eureka" class="header-anchor">#</a> Eureka</h1> <h3 id="eureka是什么"><a href="#eureka是什么" class="header-anchor">#</a> eureka是什么？</h3> <p>​					eureka是Netflix的子模块之一，也是一个核心的模块，eureka里有2个组件，一个是EurekaServer(一个独立的项目) 这个是用于定位服务以实现中间层服务器的负载平衡和故障转移，另一个便是EurekaClient（我们的微服务） 它是用于与Server交互的，可以使得交互变得非常简单:只需要通过服务标识符即可拿到服务。</p> <h3 id="与spring-cloud的关系"><a href="#与spring-cloud的关系" class="header-anchor">#</a> 与spring-cloud的关系：</h3> <p>Spring Cloud 封装了 Netflix 公司开发的 Eureka 模块来实现服务注册和发现(可以对比Zookeeper)。</p> <p>Eureka 采用了 C-S 的设计架构。Eureka Server 作为服务注册功能的服务器，它是服务注册中心。</p> <p>而系统中的其他微服务，使用 Eureka 的客户端连接到 Eureka Server并维持心跳连接。这样系统的维护人员就可以通过 Eureka Server 来监控系统中各个微服务是否正常运行。SpringCloud 的一些其他模块（比如Zuul）就可以通过 Eureka Server 来发现系统中的其他微服务，并执行相关的逻辑。</p> <h3 id="角色关系图"><a href="#角色关系图" class="header-anchor">#</a> 角色关系图：</h3> <p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/563988/1583298803542-2e6f615d-b7a1-4976-ab4e-85f8b3df1b0a.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="eureka角色关系图.jpg"></p> <h3 id="如何使用"><a href="#如何使用" class="header-anchor">#</a> 如何使用？</h3> <p>​					在spring-cloud项目里面加入依赖：</p> <p>​				     eureka客户端：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>​					 eureka服务端：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>​		eureka服务端项目里面加入以下配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server:
  port: 3000
eureka:
  server:
    enable-self-preservation: false  #关闭自我保护机制
    eviction-interval-timer-in-ms: 4000 #设置清理间隔（单位：毫秒 默认是60*1000）
  instance:
    hostname: localhost


  client:
    registerWithEureka: false #不把自己作为一个客户端注册到自己身上
    fetchRegistry: false  #不需要从服务端获取注册信息（因为在这里自己就是服务端，而且已经禁用自己注册了）
    serviceUrl:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>​	当然，不是全部必要的，这里只是把我这里的配置copy过来了</p> <p>​	然后在spring-boot启动项目上 加入注解:@EnableEurekaServer  就可以启动项目了</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@EnableEurekaServer
@SpringBootApplication
public class AppEureka {

    public static void main(String[] args) {
        SpringApplication.run(AppEureka.class);

    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>如果看见这个图片，那么说明你就搭建好了:</p> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/563988/1583298816264-0ea929a4-9bdb-4763-b09a-7c7bce380b2e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="eureka服务端效果图.png"></p> <p>这个警告只是说你把他的自我保护机制关闭了</p> <p>eureka客户端配置:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server:
  port: 6000
eureka:
  client:
    serviceUrl:
        defaultZone: http://localhost:3000/eureka/  #eureka服务端提供的注册地址 参考服务端配置的这个路径
  instance:
    
    instance-id: power-1 #此实例注册到eureka服务端的唯一的实例ID 
    prefer-ip-address: true #是否显示IP地址
    leaseRenewalIntervalInSeconds: 10 #eureka客户需要多长时间发送心跳给eureka服务器，表明它仍然活着,默认为30 秒 (与下面配置的单位都是秒)
    leaseExpirationDurationInSeconds: 30 #Eureka服务器在接收到实例的最后一次发出的心跳后，需要等待多久才可以将此实例删除，默认为90秒

spring:
  application:
    name: server-power #此实例注册到eureka服务端的name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>然后在客户端的spring-boot启动项目上 加入注解:@EnableEurekaClient  就可以启动项目了 这里就不截图了我们直接来看效果图：</p> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/563988/1583298829220-a30b5903-16be-4d1d-b317-a3ad3c646ab8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="eureka客户端效果图.png"></p> <p>这里我们能看见 名字叫server-power的（图中将其大写了） id为 power-1的服务 注册到我们的Eureka上面来了 至此，一个简单的eureka已经搭建好了。</p> <h2 id="eureka集群"><a href="#eureka集群" class="header-anchor">#</a> eureka集群:</h2> <h3 id="eureka集群原理"><a href="#eureka集群原理" class="header-anchor">#</a> eureka集群原理</h3> <p>​			服务启动后向Eureka注册，Eureka Server会将注册信息向其他Eureka Server进行同步，当服务消费者要调用服务提供者，则向服务注册中心获取服务提供者地址，然后会将服务提供者地址缓存在本地，下次再调用时，则直接从本地缓存中取，完成一次调用。</p> <h3 id="eureka集群配置"><a href="#eureka集群配置" class="header-anchor">#</a> eureka集群配置</h3> <p>​			刚刚我们了解到 Eureka Server会将注册信息向其他Eureka Server进行同步 那么我们得声明有哪些server呢？</p> <p>这里 假设我们有3个Eureka Server 如图：</p> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/563988/1583298867600-6176d79d-f663-48b7-b3c8-e8b740d289a2.png" alt="QQ截图20190106213959.png"></p> <p>现在怎么声明集群环境的server呢？ 我们看一张图：</p> <p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/563988/1583298878937-df161bcc-5e49-4ae0-87c6-f05d819456ed.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="eureka集群示意图.jpg"></p> <p>可能看着有点抽象，我们来看看具体配置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server:
  port: 3000
eureka:
  server:
    enable-self-preservation: false
    eviction-interval-timer-in-ms: 4000
  instance:
    hostname: eureka3000.com


  client:
    registerWithEureka: false
    fetchRegistry: false
    serviceUrl:
      defaultZone: http://eureka3001.com:3001/eureka,http://eureka3002.com:3002/eureka
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这里 方便理解集群 我们做了一个域名的映射(条件不是特别支持我使用三台笔记本来测试。。。) 至于域名怎么映射的话 这里简单提一下吧 修改你的hosts文件（win10的目录在C:\Windows\System32\drivers\etc 其他系统的话自行百度一下把）附上我的hosts文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>   127.0.0.1  eureka3000.com
   127.0.0.1  eureka3001.com
   127.0.0.1  eureka3002.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们回到主题， 我们发现 集群配置与单体不同的点在于 原来是把服务注册到自己身上，而现在是注册到其它服务身上</p> <p>至于为什么不注册自己了呢？，回到最上面我们说过，eureka的server会把自己的注册信息与其他的server同步，所以这里我们不需要注册到自己身上，因为另外两台服务器会配置本台服务器。(这里可能有点绕，可以参考一下刚刚那张集群环境的图，或者自己动手配置一下，另外两台eureka的配置与这个是差不多的，就不发出来了，只要注意是注册到其他的服务上面就好了)</p> <p>当三台eureka配置好之后，全部启动一下就可以看见效果了:<img src="https://cdn.nlark.com/yuque/0/2020/png/563988/1583298940835-e9df5fae-a2f7-4ba2-871b-014317cdbf79.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="集群eureka效果图.png"></p> <p>当然，我们这里仅仅是把服务端配置好了， 那客户端怎么配置呢？ 话不多说，上代码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  client:
    serviceUrl:
        defaultZone: http://localhost:3000/eureka/,http://eureka3001.com:3001/eureka,http://eureka3002.com:3002/eureka
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们这里只截取了要改动的那一部分。 就是 原来是注册到那一个地址上面，现在是要写三个eureka注册地址，但是不是代表他会注册三次，因为我们eureka server的注册信息是同步的，这里只需要注册一次就可以了，但是为什么要写三个地址呢。因为这样就可以做到高可用的配置：打个比方有3台服务器。但是突然宕机了一台， 但是其他2台还健在，依然可以注册我们的服务，换句话来讲， 只要有一台服务还建在，那么就可以注册服务，这里 需要理解一下。</p> <p>这里效果图就不发了， 和之前单机的没什么两样，只是你服务随便注册到哪个eureka server上其他的eureka server上都有该服务的注册信息。</p> <h2 id="cap定理的含义"><a href="#cap定理的含义" class="header-anchor">#</a> CAP定理的含义：</h2> <p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/563988/1583299006622-5dd0bcb3-049c-425a-8e3f-f99fa779ee4e.jpeg" alt="cap定理.jpg"></p> <p>1998年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有三个指标。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Consistency --- 一致性
Availability ---可用性
Partition tolerance  ---分区容错性
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>他们第一个字母分别是C,A,P</p> <p>Eric Brewer 说，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。</p> <h3 id="partition-tolerance"><a href="#partition-tolerance" class="header-anchor">#</a> Partition tolerance</h3> <p>中文叫做&quot;分区容错&quot;。</p> <p>大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是，区间通信可能失败。比如，一台服务器放在本地，另一台服务器放在外地（可能是外省，甚至是外国），这就是两个区，它们之间可能无法通信。</p> <p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/563988/1583299033940-eb0caebf-f708-4933-87cf-13ae94362044.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="分区容错.jpg"></p> <p>上图中，S1 和 S2 是两台跨区的服务器。S1 向 S2 发送一条消息，S2 可能无法收到。系统设计的时候，必须考虑到这种情况。</p> <p>一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。</p> <h3 id="consistency"><a href="#consistency" class="header-anchor">#</a> Consistency</h3> <p>Consistency 中文叫做&quot;一致性&quot;。意思是，写操作之后的读操作，必须返回该值。举例来说，某条记录是 v0，用户向 S1 发起一个写操作，将其改为 v1。</p> <p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/563988/1583299055578-ef825689-93ba-4ba2-88ff-bd5a3d1663b5.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="一致性.jpg"></p> <p>接下来用户读操作就会得到v1。这就叫一致性。</p> <p>问题是，用户有可能会向S2发起读取操作，由于G2的值没有发生变化，因此返回的是v0，所以S1和S2的读操作不一致，这就不满足一致性了</p> <p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/563988/1583299081576-cecd2e22-ddff-4f28-a630-f003fb2c7685.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="一致性，读.jpg"></p> <p>为了让S2的返回值与S1一致，所以我们需要在往S1执行写操作的时候，让S1给S2也发送一条消息，要求G2也变成v1</p> <p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/563988/1583299084879-e8fdbf9f-fb96-4336-bfd9-cadf0796bad4.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="一致性，读2.jpg"></p> <p>这样子用户向G2发起读操作，就也能得到v1</p> <p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/563988/1583299088396-dd9fa56e-3631-4527-81a7-65188279076b.jpeg?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_6bKB54-t5a2m6Zmi5Ye65ZOB%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="统一一致.jpg"></p> <h3 id="availability"><a href="#availability" class="header-anchor">#</a> Availability</h3> <p>​		Availability 中文叫做&quot;可用性&quot;，意思是只要收到用户的请求，服务器就必须给出回应。</p> <p>用户可以选择向 S1 或 S2 发起读操作。不管是哪台服务器，只要收到请求，就必须告诉用户，到底是 v0 还是 v1，否则就不满足可用性。</p> <h3 id="consistency-和-availability-的矛盾"><a href="#consistency-和-availability-的矛盾" class="header-anchor">#</a> Consistency 和 Availability 的矛盾</h3> <p>一致性和可用性，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分区容错）。</p> <p>如果保证 S2 的一致性，那么 S1 必须在写操作时，锁定 S2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，S2 不能读写，没有可用性不。</p> <p>如果保证 S2 的可用性，那么势必不能锁定 S2，所以一致性不成立。</p> <p>综上所述，S2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。</p> <h2 id="eureka对比zookeeper"><a href="#eureka对比zookeeper" class="header-anchor">#</a> Eureka对比Zookeeper：</h2> <p>​		Zookeeper在设计的时候遵循的是CP原则，即一致性,Zookeeper会出现这样一种情况，当master节点因为网络故障与其他节点失去联系时剩余节点会重新进行leader选举，问题在于，选举leader的时间太长：30~120s，且选举期间整个Zookeeper集群是不可用的，这就导致在选举期间注册服务处于瘫痪状态，在云部署的环境下，因网络环境使Zookeeper集群失去master节点是较大概率发生的事情，虽然服务能够最终恢复，但是漫长的选举时间导致长期的服务注册不可用是不能容忍的。</p> <p>​		Eureka在设计的时候遵循的是AP原则，即可用性。Eureka各个节点（服务)是平等的， 没有主从之分，几个节点down掉不会影响正常工作，剩余的节点（服务） 依然可以提供注册与查询服务，而Eureka的客户端在向某个Eureka注册或发现连接失败，则会自动切换到其他节点，也就是说，只要有一台Eureka还在，就能注册可用（保证可用性）， 只不过查询到的信息不是最新的（不保证强一致），除此之外，Eureka还有自我保护机制，如果在15分钟内正常心跳的节点小于85%节点，那么eureka就认为客户端与注册中心出现了网络故障，此时会出现一下情况:</p> <p>1:Eureka 不再从注册列表中移除因为长时间没有收到心跳而过期的服务。</p> <p>2：Eureka 仍然能够接收新服务的注册和查询请求，但是不会被同步到其它节点上（即保证当前节点可用）</p> <p>3： 当网络稳定后，当前实例新的注册信息会被同步到其它节点中</p> <p>自我保护机制：(主要是针对eureka服务本身出现问题)当eureka判断有大量的微服务心跳过期，就会尝试启动自我保护机制，不会主动剔除服务</p> <p>id：用来标识唯一的微服务</p> <p>name：标识某个微服务的集群</p> <h2 id="源码解析"><a href="#源码解析" class="header-anchor">#</a> 源码解析：</h2> <p>eureka底层用来接收网络通信的框架是Jersey，与springMvc用法差不多，与springMvc有所不用的是springMvc处理请求是基于servlet的，Jersey是基于filter的</p> <h3 id="eureka-server源码"><a href="#eureka-server源码" class="header-anchor">#</a> Eureka Server源码</h3> <p>比较重要的属性：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//存放注册的微服务</span>
 <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Lease</span><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> registry
            <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Lease</span><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//具体的微服务实例</span>
<span class="token class-name">InstanceInfo</span>
    lastDirtyTimestamp：微服务实例对象最后操作的时间戳
<span class="token comment">//租债器对象</span>
<span class="token class-name">Lease</span>
    registrationTimestamp：服务注册的事件戳
    serviceUpTimestamp：恢复正常工作状态的时间戳
    evictionTimestamp：服务被剔除的时间戳
    lastUpdateTimestamp：最后操作时间戳<span class="token punctuation">,</span>用于心跳续约，服务剔除
    <span class="token number">1596458413497</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">-</span><span class="token number">3</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">13</span>
    <span class="token number">1596458448729</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">-</span><span class="token number">3</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">48</span>
    
numberOfRenewsPerMinThreshold：自我保护阈值
expectedNumberOfClientsSendingRenews：客户端数量
renewalPercentThreshold：自我保护机制的触发百分比，默认<span class="token number">85</span><span class="token operator">%</span><span class="token punctuation">(</span>当正常的微服务数量大小小于<span class="token number">85</span><span class="token operator">%</span>时<span class="token punctuation">)</span>
shouldEnableSelfPreservation：是否开启了自我保护机制
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>上面的registry为存放注册的微服务的map，分析一下此数据结构</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596460106974.png" alt="1596460106974"></p> <p>例如上图所示：有一个微服务集群，为订单服务（order），拆分成了3个微服务。</p> <p>注册到eureka服务端后，ConcurrentHashMap&lt;String, Map&lt;String, Lease<InstanceInfo>&gt;&gt;</InstanceInfo></p> <p>String为：order</p> <p>对应的value,也就是后面的Map，有三个键值对，分别为：</p> <p>order_1： Lease<InstanceInfo></InstanceInfo></p> <p>order_2：Lease<InstanceInfo></InstanceInfo></p> <p>order_3：Lease<InstanceInfo></InstanceInfo></p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596460913123.png" alt="1596460913123"></p> <h4 id="配置生效"><a href="#配置生效" class="header-anchor">#</a> 配置生效</h4> <p>eureka与springcloud整合的jar包是org.springframework.cloud:spring-cloud-netflix-eureka-server-2.2.3.RELEASE.jar</p> <p>在此jar包的META-INF/spring.factories文件中有一个eureka自动配置类的全路径名EurekaServerAutoConfiguration。</p> <p>在自己项目使用eureka server，除了需要添加依赖外，还要增加一个@EnableEurekaServer注解，此注解使用@Import向springboot容器中注入了一个Maker Bean，此Bean没有任何其他作用，主要作用就是让EurekaServerAutoConfigutation自动配置类上的@ConditionalOnBean注解去判断标记类是否存在，从而决定是否向springBoot容器中注入此配置类并且让此配置类生效。</p> <p>在EurekaServerAutoConfiguration类中，初始化了Jersey的Filter，并将他放入到了servlet的Filter中，指定拦截请求/eureka/*</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596118597937.png" alt="1596118597937"></p> <h4 id="服务注册"><a href="#服务注册" class="header-anchor">#</a> 服务注册</h4> <p>在com.netflix.eureka:eureka-core:1.9.21 eureka的核心包中的ApplicationResource类，此类类似于springMvc的Controller类，用来接受并处理相应的请求，其中接受服务注册的方法为：com.netflix.eureka.resources.ApplicationResource#addInstance</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@POST
    @Consumes({&quot;application/json&quot;, &quot;application/xml&quot;})
    public Response addInstance(InstanceInfo info, @HeaderParam(&quot;x-netflix-discovery-replication&quot;) String isReplication) {
        logger.debug(&quot;Registering instance {} (replication={})&quot;, info.getId(), isReplication);
        if (this.isBlank(info.getId())) {
            return Response.status(400).entity(&quot;Missing instanceId&quot;).build();
        } else if (this.isBlank(info.getHostName())) {
            return Response.status(400).entity(&quot;Missing hostname&quot;).build();
        } else if (this.isBlank(info.getIPAddr())) {
            return Response.status(400).entity(&quot;Missing ip address&quot;).build();
        } else if (this.isBlank(info.getAppName())) {
            return Response.status(400).entity(&quot;Missing appName&quot;).build();
        } else if (!this.appName.equals(info.getAppName())) {
            return Response.status(400).entity(&quot;Mismatched appName, expecting &quot; + this.appName + &quot; but was &quot; + info.getAppName()).build();
        } else if (info.getDataCenterInfo() == null) {
            return Response.status(400).entity(&quot;Missing dataCenterInfo&quot;).build();
        } else if (info.getDataCenterInfo().getName() == null) {
            return Response.status(400).entity(&quot;Missing dataCenterInfo Name&quot;).build();
        } else {
        //判断是否是云服务
            DataCenterInfo dataCenterInfo = info.getDataCenterInfo();
            if (dataCenterInfo instanceof UniqueIdentifier) {
                String dataCenterInfoId = ((UniqueIdentifier)dataCenterInfo).getId();
                if (this.isBlank(dataCenterInfoId)) {
                    boolean experimental = &quot;true&quot;.equalsIgnoreCase(this.serverConfig.getExperimental(&quot;registration.validation.dataCenterInfoId&quot;));
                    if (experimental) {
                        String entity = &quot;DataCenterInfo of type &quot; + dataCenterInfo.getClass() + &quot; must contain a valid id&quot;;
                        return Response.status(400).entity(entity).build();
                    }

                    if (dataCenterInfo instanceof AmazonInfo) {
                        AmazonInfo amazonInfo = (AmazonInfo)dataCenterInfo;
                        String effectiveId = amazonInfo.get(MetaDataKey.instanceId);
                        if (effectiveId == null) {
                            amazonInfo.getMetadata().put(MetaDataKey.instanceId.getName(), info.getId());
                        }
                    } else {
                        logger.warn(&quot;Registering DataCenterInfo of type {} without an appropriate id&quot;, dataCenterInfo.getClass());
                    }
                }
            }
			//正常情况下会走这里
            this.registry.register(info, &quot;true&quot;.equals(isReplication));
            return Response.status(204).build();
        }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>registry类图</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596119050683.png" alt="1596119050683"></p> <p>InstanceRegistry是springCloud扩展的类，在注册时首先发布了一个事件，供其他监听器监听，然后调用父类的register方法开始服务注册与集群同步</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">InstanceInfo</span> info<span class="token punctuation">,</span> <span class="token keyword">int</span> leaseDuration<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isReplication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//发布事件</span>
		<span class="token function">handleRegistration</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> leaseDuration<span class="token punctuation">,</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//调用父类进行服务注册</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> leaseDuration<span class="token punctuation">,</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl#register</p> <p>PeerAwareInstanceRegistryImpl类负责集群同步，先调用父类的register方法进行微服务注册，然后将此微服务信息发送到其他eureka服务端，做集群同步</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InstanceInfo</span> info<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isReplication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> leaseDuration <span class="token operator">=</span> <span class="token class-name">Lease</span><span class="token punctuation">.</span>DEFAULT_DURATION_IN_SECS<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getLeaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> info<span class="token punctuation">.</span><span class="token function">getLeaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDurationInSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            leaseDuration <span class="token operator">=</span> info<span class="token punctuation">.</span><span class="token function">getLeaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDurationInSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//注册实例</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> leaseDuration<span class="token punctuation">,</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//集群同步</span>
        <span class="token function">replicateToPeers</span><span class="token punctuation">(</span><span class="token class-name">Action<span class="token punctuation">.</span>Register</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> info<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>主要的注册逻辑在com.netflix.eureka.registry.AbstractInstanceRegistry#register方法中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">InstanceInfo</span> registrant<span class="token punctuation">,</span> <span class="token keyword">int</span> leaseDuration<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isReplication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            read<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//此处根据微服务注册的appName去存放注册的微服务的gMap中拿去微服务组</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Lease</span><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> gMap <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            REGISTER<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>gMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Lease</span><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> gNewMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Lease</span><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//putIfAbsent 原子性操作，如果没有此微服务组，则添加进去</span>
                gMap <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gNewMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>gMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    gMap <span class="token operator">=</span> gNewMap<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果有注册进来的微服务组，去拿指定的实例，讲道理，90%情况下是拿不到的</span>
            <span class="token class-name">Lease</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">&gt;</span></span> existingLease <span class="token operator">=</span> gMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果真的拿到了，就使用最新的微服务实例，根据existingLastDirtyTimestamp判断</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>existingLease <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>existingLease<span class="token punctuation">.</span><span class="token function">getHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Long</span> existingLastDirtyTimestamp <span class="token operator">=</span> existingLease<span class="token punctuation">.</span><span class="token function">getHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastDirtyTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Long</span> registrationLastDirtyTimestamp <span class="token operator">=</span> registrant<span class="token punctuation">.</span><span class="token function">getLastDirtyTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Existing lease found (existing={}, provided={}&quot;</span><span class="token punctuation">,</span> existingLastDirtyTimestamp<span class="token punctuation">,</span> registrationLastDirtyTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// this is a &gt; instead of a &gt;= because if the timestamps are equal, we still take the remote transmitted</span>
                <span class="token comment">// InstanceInfo instead of the server local copy.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>existingLastDirtyTimestamp <span class="token operator">&gt;</span> registrationLastDirtyTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;There is an existing lease and the existing lease's dirty timestamp {} is greater&quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot; than the one that is being registered {}&quot;</span><span class="token punctuation">,</span> existingLastDirtyTimestamp<span class="token punctuation">,</span> registrationLastDirtyTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Using the existing instanceInfo instead of the new instanceInfo as the registrant&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    registrant <span class="token operator">=</span> existingLease<span class="token punctuation">.</span><span class="token function">getHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// The lease does not exist and hence it is a new registration</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expectedNumberOfClientsSendingRenews <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Since the client wants to register it, increase the number of clients sending renews</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>expectedNumberOfClientsSendingRenews <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expectedNumberOfClientsSendingRenews <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token function">updateRenewsPerMinThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;No previous lease information found; it is new registration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Lease</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">&gt;</span></span> lease <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lease</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InstanceInfo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>registrant<span class="token punctuation">,</span> leaseDuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>existingLease <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lease<span class="token punctuation">.</span><span class="token function">setServiceUpTimestamp</span><span class="token punctuation">(</span>existingLease<span class="token punctuation">.</span><span class="token function">getServiceUpTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//存入存放注册的微服务的map集合</span>
            gMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lease<span class="token punctuation">)</span><span class="token punctuation">;</span>
            recentRegisteredQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    registrant<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// This is where the initial state transfer of overridden status happens</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">InstanceStatus</span><span class="token punctuation">.</span>UNKNOWN<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getOverriddenStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Found overridden status {} for instance {}. Checking to see if needs to be add to the &quot;</span>
                                <span class="token operator">+</span> <span class="token string">&quot;overrides&quot;</span><span class="token punctuation">,</span> registrant<span class="token punctuation">.</span><span class="token function">getOverriddenStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>overriddenInstanceStatusMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Not found overridden id {} and hence adding it&quot;</span><span class="token punctuation">,</span> registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    overriddenInstanceStatusMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registrant<span class="token punctuation">.</span><span class="token function">getOverriddenStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">InstanceStatus</span> overriddenStatusFromMap <span class="token operator">=</span> overriddenInstanceStatusMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>overriddenStatusFromMap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Storing overridden status {} from map&quot;</span><span class="token punctuation">,</span> overriddenStatusFromMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                registrant<span class="token punctuation">.</span><span class="token function">setOverriddenStatus</span><span class="token punctuation">(</span>overriddenStatusFromMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Set the status based on the overridden status rules</span>
            <span class="token class-name">InstanceStatus</span> overriddenInstanceStatus <span class="token operator">=</span> <span class="token function">getOverriddenInstanceStatus</span><span class="token punctuation">(</span>registrant<span class="token punctuation">,</span> existingLease<span class="token punctuation">,</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
            registrant<span class="token punctuation">.</span><span class="token function">setStatusWithoutDirty</span><span class="token punctuation">(</span>overriddenInstanceStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// If the lease is registered with UP status, set lease service up timestamp</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">InstanceStatus</span><span class="token punctuation">.</span>UP<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lease<span class="token punctuation">.</span><span class="token function">serviceUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            registrant<span class="token punctuation">.</span><span class="token function">setActionType</span><span class="token punctuation">(</span><span class="token class-name">ActionType</span><span class="token punctuation">.</span>ADDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            recentlyChangedQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RecentlyChangedItem</span><span class="token punctuation">(</span>lease<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            registrant<span class="token punctuation">.</span><span class="token function">setLastUpdatedTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">invalidateCache</span><span class="token punctuation">(</span>registrant<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registrant<span class="token punctuation">.</span><span class="token function">getVIPAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registrant<span class="token punctuation">.</span><span class="token function">getSecureVipAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Registered instance {}/{} with status {} (replication={})&quot;</span><span class="token punctuation">,</span>
                    registrant<span class="token punctuation">.</span><span class="token function">getAppName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registrant<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registrant<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isReplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            read<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><p>当eureka服务端注册完成后，就会去集群同步，根据配置文件配置的其他eureka服务端地址，依次发送请求，此请求与客户端发送的注册请求大体一样。</p> <h4 id="心跳续约"><a href="#心跳续约" class="header-anchor">#</a> 心跳续约</h4> <p>每个微服务会定时发送请求，给注册中心以确认服务还在正常工作，服务会保存最后一次操作的时间（注册，心跳续约，服务下架都算操作）</p> <p>服务端入口在com.netflix.eureka.resources.InstanceResource#renewLease方法，此方法处理客户端心跳续约的请求</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596458844779.png" alt="1596458844779"></p> <p>心跳续约将简单点，就是将租债器的最后操作时间戳更新。</p> <p><strong>但是此处有一个eureka的bug，在租债器中有一个判断实例是否过期的方法</strong><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596459563484.png" alt="1596459563484" style="zoom:200%;"></p> <h4 id="服务下架"><a href="#服务下架" class="header-anchor">#</a> 服务下架</h4> <p><strong>服务剔除与服务下架的区别：</strong></p> <p>服务剔除：eureka服务端主动发现过期的eureka客户端，并将此客户端剔除</p> <p>服务下架：eureka客户端主动发送下架请求，服务端将此客户端下架</p> <p>程序入口：com.netflix.eureka.resources.InstanceResource#cancelLease</p> <p>最后会将此实例从map中删除</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596547690845.png" alt="1596547690845"></p> <p>最后会将此实例对应的租债器的evictionTimestamp属性（服务被剔除的时间戳）设置为当前时间（此处不知道为什么？因为前面已经将他删除了）</p> <h4 id="服务剔除"><a href="#服务剔除" class="header-anchor">#</a> 服务剔除</h4> <p>服务剔除定时器默认(60 * 1000) 1分钟执行一次。</p> <p>服务端在收到最后一次心跳后等待的时间上限，默认是90s，超过则剔除</p> <p>注意：服务剔除并不会集群同步，因为没有必要，每个服务端都会维护定时器去剔除服务。</p> <p>在配置生效阶段，EurekaServerAutoConfiguration自动配置类，使用@Import注解导入了一个EurekaServerInitializerConfiguration类，此类实现了ServletContextAware, SmartLifecycle两个接口。</p> <p>ServletContextAware：spring环境初始化完成后，将ServletContext容器上下文对象给实现了此接口的类。SmartLifecycle：在spring容器启动后，销毁前做一些自定义的事情。</p> <p>主要的实现在org.springframework.cloud.netflix.eureka.server.EurekaServerInitializerConfiguration#start方法</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596549657229.png" alt="1596549657229"></p> <p>此处新开一个线程，去初始化eureka环境，如果报错，不影响主线程执行。</p> <p>org.springframework.cloud.netflix.eureka.server.EurekaServerBootstrap#contextInitialized</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596549683540.png" alt="1596549683540"></p> <p>org.springframework.cloud.netflix.eureka.server.EurekaServerBootstrap#initEurekaServerContext</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596549943239.png" alt="1596549943239"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>int registryCount = this.registry.syncUp();
用来同步eureka服务端中的微服务实例，例如：eurekaServer1 中有10个微服务，过了5分钟，eurekaServer2启动，代码走到这里，会去同步这10个微服务
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl#syncUp</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596550135236.png" alt="1596550135236"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//同步并且注册的微服务实例数量</span>
<span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//重试次数</span>
serverConfig<span class="token punctuation">.</span><span class="token function">getRegistrySyncRetries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//重试等待时间</span>
serverConfig<span class="token punctuation">.</span><span class="token function">getRegistrySyncRetryWaitMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//用客户端的代码去拉取微服务信息</span>
<span class="token class-name">Applications</span> apps <span class="token operator">=</span> eurekaClient<span class="token punctuation">.</span><span class="token function">getApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//注册，此处看到第三个参数传的true，表示注册完后就不会同步了</span>
<span class="token function">register</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getLeaseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDurationInSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>同步任务完成后，主线程继续向下执行，到了初始化服务剔除的定时器。</p> <p>在com.netflix.eureka.registry.AbstractInstanceRegistry#postInit方法中</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596550534837.png" alt="1596550534837"></p> <p>具体的剔除逻辑在com.netflix.eureka.registry.AbstractInstanceRegistry#evict(long)方法</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596551667630.png" alt="1596551667630"></p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596551749494.png" alt="1596551749494"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 判断是否已经触发了自我保护机制，如果触发就不再剔除过期服务</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLeaseExpirationEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 判断具体的微服务是否过期（此处就出现了上面介绍的bug）</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>lease<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span>additionalLeaseMs<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lease<span class="token punctuation">.</span><span class="token function">getHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">// 本地存在的所有的微服务数量</span>
<span class="token keyword">int</span> registrySize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">getLocalRegistrySize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 自我保护机制阈值</span>
<span class="token keyword">int</span> registrySizeThreshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>registrySize <span class="token operator">*</span> serverConfig<span class="token punctuation">.</span><span class="token function">getRenewalPercentThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//在不触发自我保护机制情况下，可以剔除的最大服务数量</span>
<span class="token keyword">int</span> evictionLimit <span class="token operator">=</span> registrySize <span class="token operator">-</span> registrySizeThreshold<span class="token punctuation">;</span>
<span class="token comment">//找到最小值</span>
<span class="token keyword">int</span> toEvict <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>expiredLeases<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evictionLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//随机剔除</span>
<span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

此处为什么计算最小值<span class="token operator">?</span>
    eureka存在自我保护机制，默认阈值为<span class="token number">85</span><span class="token operator">%</span>，也就是说<span class="token number">15</span>分钟内超过<span class="token number">15</span><span class="token operator">%</span>节点都没有正常心跳，就不会再剔除服务了，所以此处需要判断过期的服务数量，是否大于<span class="token number">15</span><span class="token operator">%</span>，如果大于<span class="token number">15</span><span class="token operator">%</span>，那么只会剔除<span class="token number">15</span><span class="token operator">%</span>的服务。
此处为什么需要随机剔除<span class="token operator">?</span>
    主要是高可用的一种体现。
    例如：现在eureka服务端中有<span class="token number">7</span>个微服务，分为<span class="token number">2</span>个微服务组。
    order<span class="token operator">:</span>order1 order2 order3
    inventory<span class="token operator">:</span>inventory1 inventory2 inventory3 inventory4
    加入现在服务端找到order1 order2 order3 inventory1需要剔除，此时剔除的值已经大于<span class="token number">15</span><span class="token operator">%</span>，所以按照<span class="token number">15</span><span class="token operator">%</span>来剔除，此处随机就可以最大程度保证单个微服务组不会在一次全部剔除完。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="集群同步"><a href="#集群同步" class="header-anchor">#</a> 集群同步</h4> <p>集群同步一定是eureka服务端发起的，此处只举例服务注册，当一个eureka客户端发送到某一个eureka服务端服务注册请求，eureka服务端注册完成后，就会执行集群同步方法。</p> <p>集群同步的原理其实很简单，例如：客户端服务注册的请求为：localhost:XXX/eureka/register.do，那么eureka服务端同样会发送此请求到其他的eureka服务端。</p> <p>唯一不同的是其中一个参数：isReplication 是否是集群同步请求</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596340149474.png" alt="1596340149474"></p> <p>当一个eureka服务端开始集群同步操作时，虽然会发送同样的请求到其他eureka服务端，但是会在请求的请求头中加入isReplication表明此请求是一个集群同步请求，当其他eureka服务端接收到此请求，将注册信息注册到gMap，同样调用集群同步时，根据此参数判断，如果是集群同步请求就直接return，避免了死循环。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//服务注册完成后，集群同步方法
private void replicateToPeers(Action action, String appName, String id,
                                  InstanceInfo info /* optional */,
                                  InstanceStatus newStatus /* optional */, boolean isReplication) {
        Stopwatch tracer = action.getTimer().start();
        try {
            if (isReplication) {
                numberOfReplicationsLastMin.increment();
            }
            //此处判断如果配置的eureka服务端为空，或者此请求是集群同步请求，直接return，避免了死循环
            if (peerEurekaNodes == Collections.EMPTY_LIST || isReplication) {
                return;
            }
			
			//拿到配置的所有的eureka服务端信息
            for (final PeerEurekaNode node : peerEurekaNodes.getPeerEurekaNodes()) {
                // 剔除自身
                if (peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) {
                    continue;
                
                //发送相同的请求到其他eureka服务端，进行集群同步
                replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node);
            }
        } finally {
            tracer.stop();
        }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="自我保护机制"><a href="#自我保护机制" class="header-anchor">#</a> 自我保护机制</h4> <p>**自我保护机制：**服务端内部维护一个定时任务每15分钟内检查一遍，当最近一分钟保持正常心跳的服务小于85%时，启动自我保护</p> <p>**自我保护机制阈值的更新：**在服务注册，服务下架，服务端初始化，以及服务端每隔15分钟自动检查时阈值会更新</p> <ol><li>例如在服务注册时，当服务添加到ConcurrentHashMap中后，先更新客户端数量expectedNumberOfClientsSendingRenews，然后根据算法算出最新的自我保护机制阈值numberOfRenewsPerMinThreshold。</li></ol> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596790057851.png" alt="1596790057851"></p> <p>自我保护机制阈值的算法：预估心跳值(所有注册上来的实例) * 每分钟触发的心跳连接次数(60s / 服务端每分钟心跳连接刷新时间(默认30s) * 自我保护机制的触发百分比(85%))</p> <p><strong>注意：</strong></p> <ol><li>此处的心跳续约的刷新时间取的是服务端的配置，而不是客户端的配置，所以如果想让自我保护机制正常运行，需要客户端的每分钟心跳连接次数与服务端配置相同。</li> <li>此处使用60s / 服务端每分钟心跳连接刷新时间 是因为此处的计算单位为分钟，而心跳续约的刷新时间单位为秒</li></ol> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596790261225.png" alt="1596790261225"></p> <ol start="2"><li>服务端内部维护定时任务，每隔15分钟触发一次，判断最近一分钟之内，心跳连接的数量是否小于自我保护机制的阈值。</li></ol> <p>定时任务启动调用栈：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>	com.netflix.eureka.DefaultEurekaServerContext#initialize
	com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl#init
com.netflix.eureka.registry.PeerAwareInstanceRegistryImpl#scheduleRenewalThresholdUpdateTask
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>自我保护机制触发：</strong></p> <p>服务剔除时，触发判断。</p> <p>com.netflix.eureka.registry.AbstractInstanceRegistry#evict(long)</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596792905867.png" alt="1596792905867"></p> <p>服务端缓存架构</p> <p>三层缓存，读写分离架构</p> <p>​	readOnlyMap 只读缓存</p> <p>​	Guava 读写缓存</p> <p>​	registry 真实数据</p> <p>正常情况下registry 是一个ConcurrentHashMap,他是不支持读写分离的</p> <p>这种缓存三层架构的方式可以让他支持读写分离</p> <p>为什么需要三层缓存架构</p> <p>因为如果只有真实缓存的话，读写操作是会冲突的，也就是会有锁冲突，在写时是不能读的，</p> <p>这种三层缓存架构可以将读写操作分离开来，也就避免了频繁的读写导致的锁冲突，大大提高了效率</p> <h3 id="eureka-client-源码"><a href="#eureka-client-源码" class="header-anchor">#</a> Eureka Client 源码</h3> <h4 id="配置生效-2"><a href="#配置生效-2" class="header-anchor">#</a> 配置生效</h4> <p>在spring-cloud-netflix-eureka-client-2.2.3.RELEASE.jar中的META-INF/spring.factories，springboot自动配置中注入了一个EurekaClientAutoConfiguration客户端的自动配置类，在此类中向spring boot 容器中注入了一个EurekaClient类，用来初始化客户端。</p> <p>重要的属性：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>config.shouldRegisterWithEureka() 客户端是否开启服务注册功能
config.shouldFetchRegistry() 客户端是否开启服务发现功能
clientConfig.shouldEnforceRegistrationAtInit() 客户端初始化时是否应该强制初始注册
clientConfig.getRegistryFetchIntervalSeconds() 客户端服务发现定时任务执行间隔 默认30s
renewalIntervalInSecs 心跳续约间隔时间 默认30s
HeartbeatThread.class 具体心跳续约的逻辑 
scheduler 调度任务，管理心跳续约以及拉取注册信息的任务
heartbeatExecutor 客户端心跳续约线程池
cacheRefreshExecutor 客户端拉取注册信息线程池
cacheRefreshTask 客户端拉取注册信息的具体任务
heartbeatTask 客户端心跳续约的具体任务

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>client初始化主要的逻辑在com.netflix.discovery.DiscoveryClient#DiscoveryClient(com.netflix.appinfo.ApplicationInfoManager, com.netflix.discovery.EurekaClientConfig, com.netflix.discovery.AbstractDiscoveryClientOptionalArgs, javax.inject.Provider&lt;com.netflix.discovery.BackupRegistry&gt;, com.netflix.discovery.shared.resolver.EndpointRandomizer)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//其中373行，此处判断是否开启了服务注册与服务发现功能，如果没开启就没必要接着初始化了直接return</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">shouldRegisterWithEureka</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">shouldFetchRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 



<span class="token comment">//397-419行，初始化任务调度器以及两个任务线程池</span>
    
scheduler <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DiscoveryClient-%d&quot;</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            heartbeatExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> clientConfig<span class="token punctuation">.</span><span class="token function">getHeartbeatExecutorThreadPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DiscoveryClient-HeartbeatExecutor-%d&quot;</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// use direct handoff</span>

            cacheRefreshExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                    <span class="token number">1</span><span class="token punctuation">,</span> clientConfig<span class="token punctuation">.</span><span class="token function">getCacheRefreshExecutorThreadPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;DiscoveryClient-CacheRefreshExecutor-%d&quot;</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// use direct handoff</span>


<span class="token comment">//clientConfig.shouldFetchRegistry() 是否开启服务发现，根据配置文件</span>
<span class="token comment">//fetchRegistry(false) 此方法是一个很重要的方法，客户端服务发现的具体逻辑，此处判断去服务端是否能拿到，</span>
<span class="token comment">//如果拿不到，从备份注册表中获取注册表信息，如果所有eureka服务器无法访问url。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">shouldFetchRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">fetchRegistry</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从备份注册表中获取注册表信息，如果所有eureka服务器无法访问url。</span>
    <span class="token function">fetchRegistryFromBackup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//459行 初始化具体的异步任务 cacheRefreshTask heartbeatTask</span>
 <span class="token function">initScheduledTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h4 id="服务注册-2"><a href="#服务注册-2" class="header-anchor">#</a> 服务注册</h4> <p>目前发现在两个地方进行服务注册。</p> <ol><li>在eureka client初始化时，根据clientConfig.shouldEnforceRegistrationAtInit()配置，注册</li> <li>在心跳续约时，如果服务端返回404，就去注册</li></ol> <h4 id="心跳续约-2"><a href="#心跳续约-2" class="header-anchor">#</a> 心跳续约</h4> <p>在客户端初始化时，com.netflix.discovery.DiscoveryClient#initScheduledTasks方法，初始化两个异步任务，分别是心跳续约和服务发现。</p> <p>在下面的截图中，eureka客户端初始化了心跳续约任务</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596983200284.png" alt="1596983200284"></p> <p>具体的逻辑在com.netflix.discovery.DiscoveryClient#renew方法，此方法就是发送了一个http请求到服务端。在客户端调用此方法，发送心跳续约请求后，流程就回到了上面介绍的eureka server心跳续约的介绍。</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596984249171.png" alt="1596983565983"></p> <p><strong>注意：</strong></p> <p>此处如果服务端返回的状态码为404，则调用服务注册方法，将此微服务注册进eureka server中去。</p> <h4 id="服务下架-2"><a href="#服务下架-2" class="header-anchor">#</a> 服务下架</h4> <p>客户端服务安全下架有两种方式：</p> <ol><li>当EurekaClient这个Bean销毁时，自动执行其中的shutdown方法，此为被动调用</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>在EurekaClientAutoConfiguration自动配置类，配置EurekaClient这个Bean时，在@Bean注解中加入了destroyMethod属性
@Bean(destroyMethod = &quot;shutdown&quot;)
表示当此Bean在注销时，会执行此方法
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol><li>手动调用EurekaClient的shutdown</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>注入EurekaClient并手动调用shudown方法或者使用DiscoveryManager.shutdownComponent()方法，此方法其实也是调用了EurekaClient的shutdown方法
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="服务发现"><a href="#服务发现" class="header-anchor">#</a> 服务发现</h4> <p>服务发现在两个地方调用，一个在客户端初始化时调用，一个在客户端初始化时，初始化的定时任务中定时调用。</p> <ol><li>客户端初始化调用：com.netflix.discovery.DiscoveryClient#DiscoveryClient(com.netflix.appinfo.ApplicationInfoManager, com.netflix.discovery.EurekaClientConfig, com.netflix.discovery.AbstractDiscoveryClientOptionalArgs, javax.inject.Provider&lt;com.netflix.discovery.BackupRegistry&gt;, com.netflix.discovery.shared.resolver.EndpointRandomizer)的438行</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">if</span> <span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">shouldFetchRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">fetchRegistry</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fetchRegistryFromBackup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li><p>定时任务调用：</p> <p>com.netflix.discovery.DiscoveryClient#initScheduledTasks的cacheRefreshTask任务</p></li></ol> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596984249171.png" alt="1596984249171"></p> <p>此定时任务默认30s执行一次</p> <p>不同类型的服务发现调用的同一个方法com.netflix.discovery.DiscoveryClient#fetchRegistry</p> <p>服务发现分为两种类型：<strong>增量发现，全量发现</strong></p> <h5 id="增量拉取"><a href="#增量拉取" class="header-anchor">#</a> 增量拉取</h5> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596984545744.png" alt="1596984545744"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//客户端是否配置了禁用增量拉取</span>
clientConfig<span class="token punctuation">.</span><span class="token function">shouldDisableDelta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">//客户端是否配置了VIP地址 例如：A B C 服务，如果A配置了只拉取B</span>
<span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">getRegistryRefreshSingleVipAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token comment">//是否强制获取全量数据</span>
forceFullRegistryFetch
<span class="token comment">//本地缓存为空</span>
<span class="token punctuation">(</span>applications <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">//本地缓存为空</span>
<span class="token punctuation">(</span>applications<span class="token punctuation">.</span><span class="token function">getRegisteredApplications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">//本地缓存为空</span>
<span class="token punctuation">(</span>applications<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>增量拉取默认会拉取服务端最近3分钟的注册信息</strong></p> <p>服务端如何保证增量数据拉取到的是最近3分钟的呢?</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>在服务端维护了一个队列，只要有服务注册，服务下架，心跳续约等操作，都会放入此队列,有一个定时任务，默认30s执行一次，定时清除此队列中超过3分钟的服务，保证此队列存在的数据始终为最近3分钟的服务信息
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>增量数据拉取的具体逻辑：com.netflix.discovery.DiscoveryClient#getAndUpdateDelta</p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596985240414.png" alt="1596985240414"></p> <p><img src="https://lxkimages.oss-cn-beijing.aliyuncs.com/img/1596985559865.png" alt="1596985559865"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>增量的数据获取逻辑：
 1. 发送请求去服务端获取最近3分钟的增量数据（为空则去拉取全量数据）
 2. 更新本地的缓存
 3. 拿到本地更新过的缓存数据的hashCode
 4. 将本地的hashCode与服务端返回的hashCode比较，不同则表示客户端缓存的服务信息与服务端不相符，去拉取全量的数据（此处虽然拉取的是增量的数据，但是服务端返回的hashCode是全量数据的hashCode）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="全量拉取"><a href="#全量拉取" class="header-anchor">#</a> 全量拉取</h5> <p>全量数据的拉取与增量数据的拉取类似，不同的是调用的方法不一样com.netflix.discovery.DiscoveryClient#getAndStoreFullRegistry</p> <h2 id="对于eureka的保留问题"><a href="#对于eureka的保留问题" class="header-anchor">#</a> 对于eureka的保留问题</h2> <p>eureka中，客户端默认每30秒访问一个eureka服务端，而服务端每90秒没有感应到客户端的访问就认为该实例不可用。这样，如果一个实例挂了，别的实例可能要过90秒才知道该服务不可用，用户就有90秒的时间可能出错。我认为这不可接受，为什么不能用长连接呢，用nio的方式一直连接，也不会消耗多大的资源。</p> <p>虽然是默认90秒才能知道一个实例挂了,但是调用实例的方法可以设置超时方法哦,如果调用方法时超时,就会调用设置好的超时方法,返回一个默认的结果,而且eureka可以设置规则,多次超时就不调用这个实例了
因此,其实eureka是在某个实例挂了之后立马能做出反应的</p> <p>过期时间每次加  duration秒</p> <p>客户端心跳连接间隔：30s</p> <p>服务端剔除时默认的等待时间：90s</p></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/luxiaokaiEx/blog/edit/main/docs/_posts/随笔/Eureka (2).md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/05/25, 08:33:21</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/blog/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/blog/pages/114fc4/"><div>
            Sentinel
            <!----></div></a> <span class="date">05-24</span></dt></dl><dl><dd>02</dd> <dt><a href="/blog/pages/eb0bf1/"><div>
            Docker
            <!----></div></a> <span class="date">05-24</span></dt></dl><dl><dd>03</dd> <dt><a href="/blog/pages/0e51e2/"><div>
            Elasticsearch基本概念
            <!----></div></a> <span class="date">05-24</span></dt></dl> <dl><dd></dd> <dt><a href="/blog/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/luxiaokai" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Evan Xu | <a href="https://github.com/luxiaokai/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/blog/assets/js/app.b5a3e498.js" defer></script><script src="/blog/assets/js/2.54247e65.js" defer></script><script src="/blog/assets/js/84.a457ec68.js" defer></script>
  </body>
</html>
